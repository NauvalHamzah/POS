<%- include('./partials/header') %>
    <%- include('./partials/sidebar') %>
        <%- include('./partials/topbar') %>
            <!-- Begin Page Content -->
            <div class="container-fluid">

                <!-- Page Heading -->
                <div class="d-sm-flex align-items-center justify-content-between mb-4">
                    <h1 class="h3 mb-0 text-gray-800">Dashboard</h1>
                    <a href="#" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm">
                        <i class="fas fa-download fa-sm text-white-50"></i>
                        Generate Report
                    </a>
                </div>

                <!-- Filter Date Card-->
                <div class="card shadow mb-4">
                    <form id="filterDate" action="" method="get">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">Date Settings</h6>
                        </div>
                        <div class="card-body">
                            <div class="form-group row mb-2">
                                <div class="col-sm-6">
                                    <label for="startDate" class="col-sm-3 col-form-label">Start Date</label>
                                    <input type="date" class="form-control" id="startDate" name="startDate" value="<%= startDate %>">
                                </div>
                                <div class="col-sm-6">
                                    <label for="endDate" class="col-sm-3 col-form-label">End Date</label>
                                    <input type="date" class="form-control" id="endDate" name="endDate" value="<%= endDate %>">
                                </div>
                            </div>
                        </div>
                        <div class="card-footer py-3">
                            <button id="query" type="submit" class="btn btn-success btn-icon-split">
                                <span class="icon text-white-50">
                                    <i class="fa-solid fa-check"></i>
                                </span>
                                <span class="text">
                                    Query
                                </span>
                            </button>
                            <button id="reset" class="btn btn-warning btn-icon-split">
                                <span class="icon text-white-50">
                                    <i class="fa-solid fa-arrow-left"></i>
                                </span>
                                <span class="text">
                                    Reset
                                </span>
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Summary Cards-->
                <div class="row">

                    <!-- Purchases Card -->
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card border-left-primary shadow h-100 py-2">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                            PURCHASES</div>
                                        <div id="totalPurchases" class="h5 mb-0 font-weight-bold text-gray-800"></div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fas fa-calendar fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sales Card -->
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card border-left-success shadow h-100 py-2">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                            SALES</div>
                                        <div id="totalSales" class="h5 mb-0 font-weight-bold text-gray-800"></div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Earnings Card -->
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card border-left-info shadow h-100 py-2">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                            EARNINGS</div>
                                        <div id="totalEarnings" class="h5 mb-0 font-weight-bold text-gray-800"></div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Total Sales Card -->
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card border-left-warning shadow h-100 py-2">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                            TOTAL SALES</div>
                                        <div id="countSales" class="h5 mb-0 font-weight-bold text-gray-800"></div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fas fa-comments fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Draw Chart -->
                <div class="row">

                    <!-- Area Chart -->
                    <div class="col-xl-8 col-lg-7">
                        <div class="card shadow mb-4">
                            <!-- Card Header - Dropdown -->
                            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                                <h6 class="m-0 font-weight-bold text-primary">Earnings Overview</h6>
                                <div class="dropdown no-arrow">
                                    <a class="dropdown-toggle" href="#" role="button" id="dropdownMenuLink"
                                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
                                    </a>
                                    <div class="dropdown-menu dropdown-menu-right shadow animated--fade-in"
                                        aria-labelledby="dropdownMenuLink">
                                        <div class="dropdown-header">Dropdown Header:</div>
                                        <a class="dropdown-item" href="#">Action</a>
                                        <a class="dropdown-item" href="#">Another action</a>
                                        <div class="dropdown-divider"></div>
                                        <a class="dropdown-item" href="#">Something else here</a>
                                    </div>
                                </div>
                            </div>
                            <!-- Card Body -->
                            <div class="card-body">
                                <div class="chart-area">
                                    <div class="chartjs-size-monitor">
                                        <div class="chartjs-size-monitor-expand">
                                            <div class=""></div>
                                        </div>
                                        <div class="chartjs-size-monitor-shrink">
                                            <div class=""></div>
                                        </div>
                                    </div>
                                    <canvas id="myAreaChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pie Chart -->
                    <div class="col-xl-4 col-lg-5">
                        <div class="card shadow mb-4">
                            <!-- Card Header - Dropdown -->
                            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                                <h6 class="m-0 font-weight-bold text-primary">Revenue Sources</h6>
                                <div class="dropdown no-arrow">
                                    <a class="dropdown-toggle" href="#" role="button" id="dropdownMenuLink"
                                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
                                    </a>
                                    <div class="dropdown-menu dropdown-menu-right shadow animated--fade-in"
                                        aria-labelledby="dropdownMenuLink">
                                        <div class="dropdown-header">Dropdown Header:</div>
                                        <a class="dropdown-item" href="#">Action</a>
                                        <a class="dropdown-item" href="#">Another action</a>
                                        <div class="dropdown-divider"></div>
                                        <a class="dropdown-item" href="#">Something else here</a>
                                    </div>
                                </div>
                            </div>
                            <!-- Card Body -->
                            <div class="card-body">
                                <div class="chart-pie pt-4 pb-2">
                                    <div class="chartjs-size-monitor">
                                        <div class="chartjs-size-monitor-expand">
                                            <div class=""></div>
                                        </div>
                                        <div class="chartjs-size-monitor-shrink">
                                            <div class=""></div>
                                        </div>
                                    </div>
                                    <canvas id="myPieChart"></canvas>
                                </div>
                                <div class="mt-4 text-center small">
                                    <span class="mr-2">
                                        <i class="fas fa-circle text-primary"></i> Direct
                                    </span>
                                    <span class="mr-2">
                                        <i class="fas fa-circle text-success"></i> Customer
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Table -->
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Earnings Monthly Report</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered" id="earningMonthly" width="100%" cellspacing="0">
                                <thead>
                                    <tr>
                                        <th>Monthly</th>
                                        <th>Expense</th>
                                        <th>Revenue</th>
                                        <th>Earning</th>                
                                    </tr>
                                </thead>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
            <script src="js/areaChart.js"></script>
            <script src="js/pieChart.js"></script>

            <script>
                jQuery.extend(jQuery.fn.dataTable.ext.type.order, {
                    "monthYear-pre": function(d) {
                        // Convert "MMM YY" (e.g., "Aug 24") to Date object
                        const [month, year] = d.split(' ');
                        const date = new Date(Date.parse(`${month} 01, 20${year}`));
                        return date.getTime();
                    }
                });

                //Initialization
                $(document).ready(function () {
                    const totalPurchases = formatCurrency('<%= (totalPurchases) %>')
                    const totalSales = formatCurrency('<%= (totalSales) %>')
                    const totalEarnings = formatCurrency('<%= (totalSales-totalPurchases) %>')
                    const countSales = '<%= (countSales) %>'

                    $('#totalPurchases').text(totalPurchases)
                    $('#totalSales').text(totalSales)
                    $('#totalEarnings').text(totalEarnings)
                    $('#countSales').text(countSales)

                    const areaChartData = <%- JSON.stringify(areaChartData) %>;

                    const tableData = areaChartData.month.map((month, index) => ({
                        month: month,
                        purchase: areaChartData.purchase[index],
                        sales: areaChartData.sales[index],
                        earnings: areaChartData.earnings[index]
                    }));
                    
                    $('#earningMonthly').DataTable({
                        "lengthMenu": [[3, 10, 100], [3, 10, 100]],
                        "processing": true,
                        "data": tableData,
                        "columns": [
                            { "data": "month", "type": "monthYear" },
                            { "data": "purchase", "render": $.fn.dataTable.render.number(',', '.', 2, 'Rp ') },
                            { "data": "sales","render": $.fn.dataTable.render.number(',', '.', 2, 'Rp ') },
                            { "data": "earnings", "render": $.fn.dataTable.render.number(',', '.', 2, 'Rp ') },
                        ]
                    });
                })

                $('#reset').on('click', function(event) {
                    event.preventDefault()
                    $('#startDate').val('') 
                    $('#endDate').val('')
                    $('#filterDate').submit()
                });

                function formatCurrency(amount) {
                    let newFormat = '';
                    if (amount) {
                        newFormat = 'Rp ' + parseFloat(amount).toLocaleString('id-ID', {
                            minimumFractionDigits: 2, maximumFractionDigits: 2
                        });
                    }
                    return newFormat
                }
                const labelsArea = <%- JSON.stringify(areaChartData.month) %>
                const dataArea = <%- JSON.stringify(areaChartData.earnings) %>
                createAreaChart(labelsArea, dataArea)

                const labelsPie = ["Direct", "Customer"]
                const dataPie = ['<%= (totalSalesDirect) %>', '<%= (totalSales-totalSalesDirect) %>']
                createPieChart(labelsPie, dataPie)
            </script>
            <!-- /.container-fluid -->
            <%- include('./partials/footer') %>